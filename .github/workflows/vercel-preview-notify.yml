name: Vercel Preview Notification

on:
  deployment_status:

jobs:
  notify:
    # Only run on success/failure for non-production deployments
    # Vercel names production "Production" and previews as "Preview" or "Preview ‚Äì branchname"
    if: |
      (github.event.deployment_status.state == 'success' || github.event.deployment_status.state == 'failure') &&
      github.event.deployment_status.environment != 'Production'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      deployments: read

    steps:
      - name: Debug deployment info
        run: |
          echo "Deployment state: ${{ github.event.deployment_status.state }}"
          echo "Environment: ${{ github.event.deployment_status.environment }}"
          echo "Environment URL: ${{ github.event.deployment_status.environment_url }}"
          echo "Deployment SHA: ${{ github.event.deployment.sha }}"
          echo "Deployment ref: ${{ github.event.deployment.ref }}"

      - name: Get PR information
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.payload.deployment.sha;
            const ref = context.payload.deployment.ref;

            console.log(`Looking for PR with sha: ${sha}, ref: ${ref}`);

            // First try finding by SHA (most reliable for Vercel deployments)
            const { data: prsBySha } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: sha
            });

            console.log(`Found ${prsBySha.length} PRs by SHA`);

            if (prsBySha.length > 0) {
              const pr = prsBySha[0];
              console.log(`Using PR #${pr.number}: ${pr.title}`);
              core.setOutput('found', 'true');
              core.setOutput('number', pr.number);
              core.setOutput('title', pr.title);
              core.setOutput('url', pr.html_url);
              core.setOutput('author', pr.user.login);
              core.setOutput('description', pr.body || 'No description provided.');
              return;
            }

            // Fallback: try finding by branch name
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${ref}`
            });

            console.log(`Found ${prs.length} PRs by branch`);

            if (prs.length === 0) {
              console.log('No PR found for this deployment');
              core.setOutput('found', 'false');
              return;
            }

            const pr = prs[0];
            console.log(`Using PR #${pr.number}: ${pr.title}`);
            core.setOutput('found', 'true');
            core.setOutput('number', pr.number);
            core.setOutput('title', pr.title);
            core.setOutput('url', pr.html_url);
            core.setOutput('author', pr.user.login);
            core.setOutput('description', pr.body || 'No description provided.');

      - name: Post to Keybase
        if: steps.pr_info.outputs.found == 'true'
        env:
          KEYBASE_WEBHOOK_URL: ${{ secrets.KEYBASE_WEBHOOK_URL }}
          DEPLOYMENT_STATE: ${{ github.event.deployment_status.state }}
          PREVIEW_URL: ${{ github.event.deployment_status.environment_url }}
          PR_NUMBER: ${{ steps.pr_info.outputs.number }}
          PR_TITLE: ${{ steps.pr_info.outputs.title }}
          PR_URL: ${{ steps.pr_info.outputs.url }}
          PR_AUTHOR: ${{ steps.pr_info.outputs.author }}
          PR_DESCRIPTION: ${{ steps.pr_info.outputs.description }}
        run: |
          set -e

          if [ "$DEPLOYMENT_STATE" = "success" ]; then
            STATUS_EMOJI="‚úÖ"
            STATUS_TEXT="deployed successfully"
          else
            STATUS_EMOJI="‚ùå"
            STATUS_TEXT="failed to deploy"
          fi

          # Truncate description to first 500 chars to avoid message size issues
          TRUNCATED_DESC=$(echo "$PR_DESCRIPTION" | head -c 500)
          if [ ${#PR_DESCRIPTION} -gt 500 ]; then
            TRUNCATED_DESC="${TRUNCATED_DESC}..."
          fi

          MESSAGE="${STATUS_EMOJI} *PR #${PR_NUMBER} ${STATUS_TEXT}*

          *${PR_TITLE}*
          by @${PR_AUTHOR}

          ${TRUNCATED_DESC}

          üîó PR: ${PR_URL}
          üåê Preview: ${PREVIEW_URL}"

          echo "Sending message to Keybase..."
          curl -fsS -X POST "$KEYBASE_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg msg "$MESSAGE" '{msg: $msg}')"
          echo "Message sent successfully"
